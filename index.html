// Global variables
let questionBank = []; // Will be loaded from JSON
let testConfig = {
    questionCount: 10,
    timeLimit: 20,
    randomize: true
};

let currentTest = {
    questions: [],
    currentIndex: 0,
    answers: {},
    startTime: null,
    timer: null,
    timeRemaining: 0,
    reviewMode: false
};

// Load questions from JSON file
async function loadQuestions() {
    try {
        const response = await fetch('./questions.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        questionBank = await response.json();
        console.log(`Loaded ${questionBank.length} questions from JSON file`);
        
        // Update the max question count based on available questions
        const questionCountSlider = document.getElementById('questionCount');
        questionCountSlider.max = questionBank.length;
        if (testConfig.questionCount > questionBank.length) {
            testConfig.questionCount = questionBank.length;
            questionCountSlider.value = questionBank.length;
            updateDisplays();
        }
        
    } catch (error) {
        console.error('Error loading questions:', error);
        // Fallback to sample questions if JSON fails to load
        questionBank = [
            {
                id: 1,
                type: "multiple",
                question: "Sample question - JSON file not found",
                options: ["Option A", "Option B", "Option C", "Option D"],
                correct: 0,
                explanation: "This is a fallback question. Please check that questions.json exists."
            }
        ];
        alert('Kh√¥ng th·ªÉ t·∫£i c√¢u h·ªèi t·ª´ file JSON. S·ª≠ d·ª•ng c√¢u h·ªèi m·∫´u.\n\nCannot load questions from JSON file. Using sample questions.');
    }
}

// Initialize - Load questions when page loads
document.addEventListener('DOMContentLoaded', async function() {
    // Show loading message
    const setupDiv = document.getElementById('testSetup');
    setupDiv.innerHTML = '<h2>‚è≥ ƒêang t·∫£i c√¢u h·ªèi... / Loading questions...</h2>';
    
    // Load questions from JSON
    await loadQuestions();
    
    // Restore the original setup interface
    setupDiv.innerHTML = `
        <h2>Thi·∫øt l·∫≠p b√†i thi / Test Setup</h2>
        
        <div class="setup-options">
            <div class="option-card" data-option="questionCount">
                <h3>üìù S·ªë c√¢u h·ªèi</h3>
                <p>Questions: <span id="questionCountDisplay">10</span></p>
                <input type="range" id="questionCount" min="5" max="50" value="10" style="width: 100%; margin-top: 10px;">
            </div>
            
            <div class="option-card" data-option="timeLimit">
                <h3>‚è∞ Th·ªùi gian</h3>
                <p>Time: <span id="timeLimitDisplay">20</span> ph√∫t</p>
                <input type="range" id="timeLimit" min="5" max="60" value="20" style="width: 100%; margin-top: 10px;">
            </div>
            
            <div class="option-card" data-option="randomize" onclick="toggleRandomize()">
                <h3>üîÄ X√°o tr·ªôn</h3>
                <p id="randomizeText">Randomize: ON</p>
            </div>
        </div>
        
        <button class="start-btn" onclick="startTest()">B·∫Øt ƒë·∫ßu thi / Start Test</button>
    `;
    
    // Initialize displays
    updateDisplays();
});

function updateDisplays() {
    document.getElementById('questionCountDisplay').textContent = testConfig.questionCount;
    document.getElementById('timeLimitDisplay').textContent = testConfig.timeLimit;
    
    document.getElementById('questionCount').oninput = function() {
        testConfig.questionCount = parseInt(this.value);
        document.getElementById('questionCountDisplay').textContent = this.value;
    };
    
    document.getElementById('timeLimit').oninput = function() {
        testConfig.timeLimit = parseInt(this.value);
        document.getElementById('timeLimitDisplay').textContent = this.value;
    };
}

// Add validation before starting test
function startTest() {
    if (questionBank.length === 0) {
        alert('Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i.\n\nNo questions loaded. Please try again.');
        return;
    }
    
    if (testConfig.questionCount > questionBank.length) {
        testConfig.questionCount = questionBank.length;
        alert(`Ch·ªâ c√≥ ${questionBank.length} c√¢u h·ªèi. ƒêi·ªÅu ch·ªânh th√†nh ${questionBank.length} c√¢u.\n\nOnly ${questionBank.length} questions available. Adjusted to ${questionBank.length} questions.`);
    }
    
    // Prepare questions
    let selectedQuestions = [...questionBank];
    if (testConfig.randomize) {
        selectedQuestions = shuffle(selectedQuestions);
    }
    currentTest.questions = selectedQuestions.slice(0, testConfig.questionCount);
    
    // Reset test state
    currentTest.currentIndex = 0;
    currentTest.answers = {};
    currentTest.startTime = Date.now();
    currentTest.timeRemaining = testConfig.timeLimit * 60;
    
    // Update UI
    document.getElementById('testSetup').style.display = 'none';
    document.getElementById('testInterface').style.display = 'block';
    document.getElementById('totalQuestions').textContent = currentTest.questions.length;
    
    // Start timer
    startTimer();
    
    // Load first question
    loadQuestion();
}
